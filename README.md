<project_description>
 
# Autobgm (For SillyTavern)

## 설명
- 깃허브 내에서 SillyTavern 전용 확장 제작 중임
- **해당 확장에 대한 설명과 기능들은 "### 튜토리얼" 챕터와 "###디테일" 챕터 내에 포함되어 있으니 참고 바람**
- 설명이나 기능과 관련하여 궁금해 할만한 사안은 해당 항목들 밑에도 미리 Q, A 형식에 맞춰 자체적으로 풀어두긴 했는데, 그래도 설명이 부족할 수도 있으니 양해 바람

### 해당 확장에 대한 이해를 도울 Q&A
- Q: 왜 만듦?
  * A: 프리셋에 추가한 BGM들에 키워드를 매칭, Ai의 마지막 메시지에 해당 키워드가 있을 시 우선도에 따라 mp3 파일을 웹으로 자동 재생하는 확장을 만들고 싶었음.
- Q: 키워드 여러 개 지정 가능?
  * A: 가능함. 애초에 키워드 여러 개 지정하는 게 해당 확장 제작 목적의 핵심이었음. 쉼표로 구분하여 다수의 키워드를 매칭해주면 됨.
- Q: 키워드 지정에 대해서 감이 안 잡히는데 어떻게 쓰라는 거?
  * A: 상태창을(비슷한 거라도) 매 지문마다 작성하라는 지시사항이 프롬프트나 월드인포에 있을 시, 일관된 형식이 존재하여 키워드 형식을 특정해서 잡기 쉬워지기 때문에 시너지가 좋을 것임
  > 예를 들어... 상태창 내부에 "시간:(아침/낮/저녁/밤)"이 포함되어 있다면 BGM 키워드에 "시간:아침" 식으로 매칭해서 활용할 수 있겠음. 혹은 세계관에 지역이 포함된 캐릭터 카드 같은 경우 "장소: (장소 명칭)" 식으로 상태창에 출력하게 하여 특정 BGM별로 키워드를 매칭시킬 수 있겠음.
- Q: 그럼 현재 상황의 분위기나 특정 캐릭터들 감정에 따라 BGM 키워드를 잡을 순 없다는 거임?
  * A: 원작이 게임인 2차 자작시뮬봇을 만들다가 귀가 심심해서 만들게 된 확장이라 아무래도 캐릭터들의 감정선을 알아서 인식해서 잡기보다는, 특정 시간대나 장소를 키워드로 지정하는 걸 생각하며 기능을 만들었으니 한계가 있음. 하지만 방법은 존재하는데... 키워드를 "싸우다, 싸움, 화나다, 화, 분노, 격노..." 이딴식으로 빡세게 잡는 건 비효율적임
  > 그럼 어떻게 하느냐? 분위기, 상황, 감정 등을 상태창에 끼워넣어주면 그만임. 예를 들어 상태창에 관한 AI 지시사항에...
    # 상태창 작성 가이드라인
    - 형식: <태그이름>시간:(아침/낮/저녁/밤)|상태:({{char}}의 상태)|...</태그이름>
    ## 키-값 설명
    - 시간: 하루의 시간을 4분할로 나누는 방식. 해당 키에는 아침/낮/저녁/밤 중에 출력 ㄱㄱ
    - 상태: {{char}}의 기분과 상태에 따라 이모지를 출력. 사용할 수 있는 이모지는 하위 항목과 같음.
      * (웃는 이모지): 기쁠 때
      * (우는 이모지): 슬플 때
      * (검 이모지): 전투 중일 때
  > 위처럼 하고 키워드에는 아침, (웃는 이모지) 등을 넣으면 됨. 위에 쓴 지시사항은 예시라 대충 쓴 거고 형식은 자율임.
- Q: 그럼 한 지문 내에서 키워드 여러개가 뜨면 어떡함?
  * A: BGM List에서 각 BGM 파일 별로 우선도 설정이 가능하게 되어있음. 해당 기능 활용하면 됨. 만약 우선도까지 겹치면 그냥 그 중에 랜덤하게 재생될 거임.
- Q: 유저 메시지까지 인식함?
  * A: AI의 마지막 메시지만 인식함. BGM이 너무 자주 바뀌지 않게 하기 위해서 그렇게 해둠.

### 튜토리얼

#### For start
0) 해당 확장을 SillyTavern의 확장 프로그램 설치를 눌러 설치
( 링크: https://github.com/GgangMyChaeng/AutoBGM )
1) 확장 메뉴 중 AutoBGM을 눌러 메뉴를 펼친 뒤 Enabled를 눌러 해당 확장을 활성화
2) Enabled 버튼 아래 톱니바퀴(Settings) 버튼 클릭을 통해 해당 확장의 모달 화면 활성화
3) 프리셋 제작 or 캐릭터 카드 전용 프리셋 (봇 카드 선택 시 자동 생성됨) or 프리셋 불러오기(Import)
4) BGM 삽입 (mp3 파일을 개별로 넣거나 Zip으로 압축한 상태의 mp3 파일들도 가능)

##### @키워드 모드 사용 시...@
5) BGM list의 bgm별로 키워드 매칭 (쉼표를 사용하여 다수의 키워드 매칭 가능)
6) 개인 세팅
  * 마지막 ai 메시지에 키워드 없을 시 자동으로 재생될 Default audio 지정 (하지 않아도 무관)
  * 볼륨 조정
  * 우선도(Priority) 조정: 다수의 키워드가 지문에 걸렸을 때, 해당 값이 가장 큰 BGM을 재생
7) 키워드 모드(Keyword Mode)*가 켜져있는 상태로 모달 화면을 닫고 채팅

##### @키워드 모드 필요없는데...@
5) 재생 모드(Play Mode)를 통해 귀찮은 설정 없이 즐길 수 있겠음
6) 물론 이 경우에도 각 BGM 파일마다 각각의 볼륨 설정을(필수는 아니고 선택 사항임) 통해 좀 더 매끄럽게 사용 가능

### 디테일

#### Extensions menu
- 해당 확장을 설치 시, SillyTavern 확장 메뉴에서 AutoBGM을 발견할 수 있음
- Enabled: 해당 확장을 활성화 / 비활성화 시킬 수 있음
- 톱니바퀴(Settings) 버튼: 해당 확장의 모달을 오픈, 상세 설정이 가능함

#### Modal (AutoBGM Settings)
- 키워드 모드(Keyword Mode)란 다음과 같음: 해당 기능을 활성화할 시, Ai의 마지막 메시지에서 키워드가 인식되면 자동으로 해당 BGM이 조건에(키워드 인식, 우선도 등) 따라 자동 재생됨
- 재생 모드(Play Mode)란 다음과 같음: 키워드 모드 비활성화 시 사용할 수 있는 모드인데, 모드는 Manual(일반 재생), Loop One(단일 무한 재생), Loop List(리스트 무한 재생), Random(랜덤 재생)이 있음
  * Manual(일반 재생): 한 곡을 재생시켜두면 해당 곡 종료 시 다른 곡으로 넘어가거나 하는 이벤트는 발생하지 않음
  * Loop One(단일 무한 재생): 한 곡을 재생해두면 해당 곡만 무한 자동 재생됨
  * Loop List(리스트 무한 재생): 해당 프리셋의 BGM 리스트에 들어있는 BGM 순서대로(Sort로 순서 조정 가능) 무한 재생
  * Random(랜덤 재생): 해당 프리셋의 BGM 리스트에 들어있는 BGM을 랜덤한 순으로 무한 재생. 단, 이 경우 해당 모드를 활성시킬 두 가지 방법이 있는데...
  > 일단 아무 곡이나 재생시켜 두고 재생 모드의 Manual 상태를 Random으로 바꿔주기 (Random 재생의 첫 곡을 원하는 곡으로 시작 가능)
  > 재생 모드를 Random으로 설정해둔 후 Enabled로 확장을 껐다 켜주기 (Random 재생이지만, 처음으로 재생되는 곡은 Default로 설정해둔 곡임)
- 전체 볼륨(Global Volume): BGM List에서 BGM마다 상세 볼륨을 설정해놨어도, 해당 설정을(Global Volume) 통해 전반적인 소리 크기를 조정할 수 있음 > 어차피 사용자가 이용하는 기기가 소리 설정해줄 건데 왜 필요함?이라는 생각이 들 수 있는데 해당 설정은 mp3 파일 자체의 소리가 지나치게 작거나 커서 사용하기 불편해지는 경우를 방지하고자 만들어둔 쿠션 기능이라고 보면 됨

#### Presets
- 기능 설정에 앞서 알아둬야 할 것이 있는데, 사용 중인 프리셋의 상태는(설정은) 수정할 때마다 그 상태로 저장됨 (SillyTavern 월드인포도 키워드 변경하거나 이거저거 손댄 순간 그대로 적용되는 거니까, 그거 생각하면 이해하기 쉬움. 같은 로직임. 그래서 수정하다가 설정해둔 거 괜히 실수로 날려먹지 말라고 후술할 Import, Export 등이 있는 거임.)
- 프리셋 추가(+) 버튼: 새 프리셋 생성 기능
- 삭제(쓰레기통) 버튼: 해당 프리셋 삭제 기능 > 실수로 삭제하지 말라고 쿠션 창(확인 메시지) 하나 뜸
- 수정(연필) 버튼: 해당 프리셋 명칭 수정 기능 > 입력창에 변경할 명칭 적어두고 연필 누르면 됨
- Import: (이름)_AutoBGM.json 파일을 삽입하면, 프리셋의 명칭·mp3 파일명·키워드·우선도·볼륨 설정만 불러와짐. BGM을 위한 mp3 파일은 따로 개인이 삽입해 줘야 함. 해당 프리셋의 mp3 파일명과 일치하는 것들을 불러와주면 알아서 잘 기능할 거임.
  * Q: (이름)_AutoBGM.json이라 했는데, 해당 프리셋 json 파일 이름이 (이름)_AutoBGM 형식이 아닌 파일은 프리셋 명칭이 제대로 적용 안 되는 거 아님?
    * A: 아님. 예를 들어 "123_AutoBGM.json" 파일의 명칭을 "똥.json" 으로 바꿔줘도 확장명(json)만 살아있으면 되는 거니까 걱정하지 않아도 됨. 파일의 명칭이 프리셋 이름으로 설정되는 게 아니라 파일 내부에 프리셋 명칭 설정이 저장되는 로직이기 때문임.
- Export: 바로 위에 언급된 설정들이(해당 프리셋의 명칭·mp3 파일명·키워드·우선도·볼륨 설정) 저장된 파일이 생성됨. 해당 프리셋을 위한 mp3 파일까지 저장·공유를 하고 싶다면 개인이 따로 세팅해야 함.

#### BGM list
- MP3 파일 추가(음표): 해당 버튼을 누르면 특정 경로에 있는 MP3 파일을 인식시켜줄 수 있음
- ZIP 파일 추가(ZIP): 해당 버튼을 누르면 특정 경로에 있는 ZIP 파일을(MP3 파일이 들어가있는 ZIP) 인식시켜줄 수 있음
- Use Default when no keyword: 키워드 모드 활성화 중에, AI의 마지막 지문에 인식 된 키워드가 없을 때 원래 재생되던 이전 BGM이 아니라 Default BGM이 재생되도록 하는 기능임
- Default: 단어 그대로 뭘 기본 bgm으로 설정해두느냐임 비워두고 싶으면 (none) 상태로 두면 됨
- Sort: BGM List의 파일 정렬 순서 설정 기능임
- 선택 삭제(쓰레기통): 선택한 BGM들을 삭제해주는 기능임 > 실수로 삭제하지 말라고 쿠션 창 뜰 거임
- Expand all rows(하단): BGM 설정 창을 전부 펼쳐주는 기능임
- Collapse all rows(상단): BGM 설정 창을 전부 접어주는 기능임
- Lock all volume sliders(자물쇠): 각 BGM 볼륨을 설정해주는 슬라이더를 잠가주는 기능임 > 키워드나 우선도 설정하다가 실수로 볼륨 설정 바꿔버리는 경우를 방지해 줌, 다만 볼륨 설정 입력창까지 잠가주진 않으니 그 점 유의 바람. 볼륨 입력창은 눌러서 수치를 입력 해야 바뀌니까 굳이 실수할 거라 생각은 안 하고, 디테일한(터치로 하기 불편한 1 단위 조절이라든지) 설정을 할 수 있게 안 잠기게 해둔 거임.
  * Q: 볼륨 올 락 걸어버리면 개별 볼륨 설정은 영원히 바꿀 수 없는 거임?
    * A: 항목에 들어가서 자물쇠 풀면 다시 해당 BGM 볼륨 슬라이더 설정 사용 가능하니까 걱정 안 해도 됨.

##### BGM list Entry
- File: 파일명 변경 가능. 사용 중인 기기 내의 mp3 파일 이름이 변경되는 게 아니라 리스트 내에서만 변경되는 기능임. 리스트에 이미 인식시켜 두었던 기기 내의 BGM 파일명을(mp3 파일의 이름) 변경했을 때, 리스트에서 변경된 이름 때문에 인식하지 못할 수 있으므로 사용하라고 있는 기능.
  * Q: 파일 뒤에 붙는 확장명 거슬리는데 항목 File 이름에서 ".mp3" 지워도 됨? 그러고 BGM 파일 이름도 내 입맛대로 바꿔도 됨?
    * A: 안 됨. 그럼 리스트가 해당 파일 인식 못해서 해당 항목은 유령 항목이 됨. 무조건 "(해당 mp3 파일 원본 이름).mp3" 상태를 유지 해줘야 함.
- 펼치기/접기(More): BGM File 각각의 설정을 위한 기능. 항목 별로 펼치거나 접을 수 있음.
- 삭제(쓰레기통): 해당 항목 BGM 파일을 리스트에서 삭제해주는 기능 > 실수로 삭제할 경우를 방지하고자 쿠션 창이 하나 뜸

***

# 개발자 노트

## 현재 깃허브 폴더 상태
### AutoBGM 폴더(github root) 안에:
- index.js
- manifest.json
- style.css
### AutoBGM/templates 폴더 안에:
- popup.html
- window.html
### AutoBGM/vendor 폴더 안에:
- jszip.min.js

## 체크 리스트
### @SillyTavern확장 메뉴에서...@
- 해당 확장이 SillyTavern 내의 확장 메뉴에 뜨는가? (o)
- 확장 메뉴 ui가 적용됐는가? (o)
- 확장 메뉴에서 톱니바퀴 버튼(settings)을 눌렀을 때 모달이 뜨는가? (o)
- Enabled 버튼을 통해 해당 확장의 활성화·비활성화가 기능하는가? (O)
### @모달에서...@
- 모달 ui가 적용됐는가? (o)
- 화면폭이 줄어들거나 넓어짐에 따라 모달 창 크기가 최적화되는가? (O)
- 프리셋 ui가 정상적으로 세팅됐는가? (O)
- BGM list의 ui가 정상적으로 세팅됐는가? (o)
- BGM list의 각 항목의 설정 전체를 접거나 펼칠 수 있는가? (O)
- BGM 개별 항목 볼륨 설정 전체 락버튼이 기능하는가? (O)
- 프리셋이나 BGM 파일 삭제 전 쿠션(확인 메시지)이 뜨는가? (O)
### @프리셋에서...@
- 프리셋 기능인
  * 저장, 삭제가 작동하는가? (o)
  * 불러오기, 내보내기가 작동하는가? (o)
  * 불러오기 시, 유저의 기존 프리셋이 초기화되지 않고 해당 프리셋만 추가로 불러와지는가? (o)
  * 내보내기 시, 해당 프리셋 명칭 그대로 저장되는가? (O)
  * 특정 프리셋을 특정 캐릭터(들)에게 매칭(종속; 쉽게 말해 사용자가 해당 캐릭터 카드를 눌렀을 시 자동 연결해주는 기능)하는 스크립트 버튼이 있는가? (X)
### @BGM list에서...@
- BGM list의 기능인
  * BGM 개별 삽입, 삭제가 작동하는가? (O)
  * mp3 파일이 담긴 zip 폴더를 삽입했을 시 BGM 파일을 인식하는가? (o)
  * 키워드 저장이 작동하는가? (O)
  * 개별 볼륨 조절 설정이 저장되는가? (O)
  * 볼륨 설정 스크롤 바와 입력창의 값이 호환되는가? (O)
  * BGM이 이름 알파벳 순, 알파벳 역순 혹은 추가한 순, 추가한 역순으로 정렬되는가? (O)
  * Default BGM이 설정되는가? (O)
  * 키워드 모드 비활성화 상태에서 사용 가능한 > 일반 재생 / 랜덤 재생 / 단일 무한 재생 / 설정한 순서별 무한 재생 버튼이 있는가? (O)
- AutoBGM의 기본 기능인
  * BGM 재생, 일시정지가 작동하는가? (O)
  * 개별 볼륨 조절 설정이 작동하는가? (O)
  * 개별 볼륨 설정을 기반으로 두고(키워드 모드, 4가지 재생 모드 전부) 글로벌 볼륨이(개별 볼륨 세팅 + 전반적인 볼륨 크기 조절 형식으로) 상시 작동하는가? (X) > 되다가 가끔 안 먹는 것 같음 루프 리스트, 랜덤 모드 확인 요망
  * 키워드 모드 비활성화 상태에서 일반 재생 / 랜덤 재생 / 단일 무한 재생 / 설정한 순서별 무한 재생 기능이 정상 작동하는가? (O)
  * 특정 프리셋을 특정 캐릭터(들)에게 매칭(종속)하는 기능이 작동하는가? (X)
- 키워드 모드 활성화 중에...
  * 키워드 인식 기반 자동 재생 기능이 작동하여 Ai의({{char}}) 마지막 메시지에서만 키워드를 인식하는가? (X)
  * 해당 확장이 채팅마다 Ai의 마지막 메시지의 키워드를 인식해 각각 정상 작동하는가? (X)
  * Use Default when no keyword 설정 활성화 중에, 마지막 AI 메시지에 인식된 키워드가 없고, Default로 설정해둔 BGM이 있을 시 해당 BGM이 상시 재생되는가? (O)
  * Use Default when no keyword 설정 활성화 중에, 마지막 AI 메시지에 인식된 키워드가 없고, Default BGM도 없을 시, 재생되던 BGM이 종료되면 다른 BGM으로 넘어가는 이벤트가 방지되는가? (O)
  * Use Default when no keyword 설정은 비활성화 중이고, 마지막 AI 메시지에 인식된 키워드가 없을 시, 이전에 재생 중이었던 BGM이 유지(자동 무한 재생)되는가? (X)
  * 채팅에서 나왔을 시 BGM이 정상적으로 꺼지는가? (X)

## 원하는 기능
- 키워드 매칭 (wi처럼 쉼표로 키워드 다수 매칭 가능하게)
- 키워드 인식 후 자동 재생:
  * ai의({{char}}) 마지막 메시지에만 반응해야 함
  * 키워드 모드 활성화 중, 새로운 Ai 마지막 메시지를 인식했는데 인식된 키워드가 없고, Use Default when no keyword 설정은 비활성화 중이면 이전에 재생하던 BGM이 상시 유지(무한 재생)되어야 함
  * 키워드 모드 활성화 중에 채팅에서 나왔을 때는 자동으로 OFF되어야 함
  * 키워드 모드 활성화 중에 채팅에 다시 들어갔을 때는 ai 마지막 메시지를 인식하여 자동으로 ON되어야 함(확장 enabled일 때만)

</project_description>

## License
This project is licensed under CC BY-NC-ND 4.0.
Third-party libraries are licensed separately (see LICENSE’S NOTICE).

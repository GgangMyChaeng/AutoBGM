<!-- templates/popup.html -->
<div class="autobgm-modal">
  <div class="autobgm-modal-h">
    <b>AutoBGM Settings</b>
    <div class="menu_button" id="abgm_modal_close" title="Close">
      <i class="fa-solid fa-xmark fa-lg"></i>
    </div>
  </div>

  <div class="autobgm-modal-b">
    <!-- 상단 옵션 -->
    <div class="abgm-topbar">
      <label class="checkbox_label" style="margin:0;">
        <input type="checkbox" id="abgm_keywordMode">
        <small>Keyword Mode</small>
      </label>
      <label class="checkbox_label" style="margin:0;">
        <input type="checkbox" id="abgm_debugMode">
        <small>Debug Mode</small>
      </label>

      <div class="abgm-inline" style="min-width:240px;">
        <small style="opacity:.85;">Play Mode</small>
        <select id="abgm_playMode" class="abgm-select abgm-select-slim" title="Works when Keyword Mode is OFF">
          <option value="manual">Manual</option>
          <option value="loop_one">Loop One</option>
          <option value="loop_list">Loop List</option>
          <option value="random">Random</option>
        </select>
      </div>

      <div class="abgm-inline">
        <small style="opacity:.85;">Global Volume</small>
        <input id="abgm_globalVol" type="range" min="0" max="100" value="70" class="abgm-range">
        <small id="abgm_globalVolText" style="opacity:.85; width:38px; text-align:right;">70</small>
      </div>
    </div>

    <hr class="abgm-hr"/>

    <!-- Now Playing -->
    <div class="abgm-nowplaying" style="display:flex; gap:10px; align-items:baseline; flex-wrap:wrap; padding:8px 10px; border:1px solid rgba(255,255,255,.12); border-radius:12px; background:rgba(0,0,0,.18); margin:10px 0;">
      <small style="opacity:.75;">Now Playing</small>
      <b id="abgm_now_title" style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:100%;">(none)</b>
      <small id="abgm_now_state" style="opacity:.7;">Stopped</small>
      <small id="abgm_now_meta" style="opacity:.65;">—</small>
    </div>

    <div class="abgm-grid">
      <!-- LEFT: Presets -->
      <section class="abgm-card">
        <div class="abgm-card-h">
          <b>Presets</b>
          <div class="abgm-row">
            <div class="menu_button" id="abgm_preset_add" title="New Preset">
              <i class="fa-solid fa-plus"></i>
            </div>
            <div class="menu_button" id="abgm_preset_del" title="Delete Preset">
              <i class="fa-solid fa-trash"></i>
            </div>
          </div>
        </div>

        <div class="abgm-row" style="gap:8px;">
          <select id="abgm_preset_select" class="abgm-select"></select>
        </div>

        <div class="abgm-row" style="gap:8px; margin-top:8px;">
          <input id="abgm_preset_name" class="text_pole" placeholder="Preset name" style="flex:1;">
          <div class="menu_button" id="abgm_preset_rename" title="Rename">
            <i class="fa-solid fa-pen"></i>
          </div>
        </div>

        <div class="abgm-row" style="gap:8px; margin-top:10px; flex-wrap:wrap;">
          <div class="menu_button" id="abgm_bind_open" title="Bind this preset to character cards">
            <i class="fa-solid fa-link"></i> Bind to Characters
          </div>
        </div>

        <hr class="abgm-hr"/>

        <div class="abgm-row" style="gap:10px; flex-wrap:wrap;">
          <div class="menu_button" id="abgm_import"><i class="fa-solid fa-file-import"></i> Import</div>
          <div class="menu_button" id="abgm_export"><i class="fa-solid fa-file-export"></i> Export</div>
          <input id="abgm_import_file" type="file" accept="application/json" style="display:none;">
        </div>

        <div class="abgm-minihelp">
          프리셋은 “채팅별 세팅 묶음”이라고 보면 됨<br/>
          (나중에 캐릭터/채팅 id랑 연결할 자리)
        </div>
      </section>

      <!-- RIGHT: BGM List -->
      <section class="abgm-card">
        <div class="abgm-card-h">
          <b>BGM List</b>
          <div class="abgm-row">
            <div class="menu_button" id="abgm_bgm_add" title="Add MP3">
              <i class="fa-solid fa-music"></i>
            </div>
            <div class="menu_button" id="abgm_zip_add" title="Add ZIP">
              <i class="fa-solid fa-file-zipper"></i>
            </div>
            <input id="abgm_zip_file" type="file" accept=".zip,application/zip" style="display:none;">
          </div>
        </div>

        <div class="abgm-row" style="gap:10px; flex-wrap:wrap;">
          <label class="checkbox_label" style="margin:0;">
            <input type="checkbox" id="abgm_useDefault">
            <small>Use Default when no keyword</small>
          </label>

          <div class="abgm-inline" style="min-width:220px;">
            <small style="opacity:.85;">Default</small>
            <select id="abgm_default_select" class="abgm-select"></select>
          </div>

          <div class="abgm-row" style="gap:10px; flex-wrap:wrap; margin-top:8px;">
            <div class="abgm-inline" style="min-width:240px;">
              <small style="opacity:.85;">Sort</small>
              <select id="abgm_sort" class="abgm-select abgm-select-slim">
                <option value="added_asc">Added (old → new)</option>
                <option value="added_desc">Added (new → old)</option>
                <option value="name_asc">Name (A → Z)</option>
                <option value="name_desc">Name (Z → A)</option>
              </select>
            </div>

            <div class="menu_button" id="abgm_delete_selected" title="Delete selected rows">
              <i class="fa-solid fa-trash"></i> Delete Selected
            </div>
            <small id="abgm_selected_count" style="opacity:.75;">0 selected</small>
          </div>

          <div class="menu_button" id="abgm_expand_all" title="Expand all rows">
            <i class="fa-solid fa-angles-down"></i>
          </div>
          <div class="menu_button" id="abgm_collapse_all" title="Collapse all rows">
            <i class="fa-solid fa-angles-up"></i>
          </div>
          <div class="menu_button" id="abgm_lock_all_vol" title="Lock all volume sliders">
            <i class="fa-solid fa-lock"></i>
          </div>

          <input id="abgm_bgm_file" type="file" accept="audio/mpeg,audio/mp3" style="display:none;">
        </div>

        <div class="abgm-tablewrap">
          <table class="abgm-table">
            <thead>
              <tr>
                <th class="abgm-col-check">
                  <input type="checkbox" id="abgm_sel_all" title="Select all">
                </th>
                <th>File</th>
                <th style="width:92px;">Play</th>
                <th style="width:64px;">More</th>
              </tr>
            </thead>
            <tbody id="abgm_bgm_tbody"></tbody>
          </table>
        </div>

        <div class="abgm-minihelp">
          키워드는 쉼표로 구분 (예: rain, storm, thunder)<br/>
          우선도 높은 놈이 이김 / 키워드 변동 없으면 유지(이 로직은 다음 단계)
        </div>
      </section>
    </div>
  
  <!-- Bind Overlay (covers modal) -->
   <div id="abgm_bind_overlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; z-index:999999; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.55); padding:12px; box-sizing:border-box;">
    <div style="width:min(560px, calc(100vw - 24px)); height:min(70vh, 560px); background:rgba(20,20,20,.98); border:1px solid rgba(255,255,255,.14); border-radius:14px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,.55);">
      <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 12px 10px 12px; border-bottom:1px solid rgba(255,255,255,.10); gap:10px;">
        <b id="abgm_bind_title">Bind Preset</b>
        <div class="menu_button" id="abgm_bind_close" title="Close">
          <i class="fa-solid fa-xmark fa-lg"></i>
        </div>
      </div>

      <div style="padding:10px 12px; height:calc(100% - 52px); display:flex; flex-direction:column; gap:10px;">
        <small id="abgm_bind_sub" style="opacity:.75;">Select a character</small>
        <div id="abgm_bind_list" style="flex:1; overflow:auto; display:flex; flex-direction:column; gap:8px; padding:2px;"></div>
      </div>
    </div>
  </div>
</div>
</div>
